{% extends "base.html" %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/schedule.css' %}">

<div class="container mt-5 schedule">
  <section class="lich-chieu">
    <h2 style="color: black;">L·ªãch Chi·∫øu Phim</h2>

    <!-- üé¨ Su·∫•t chi·∫øu s·∫Øp t·ªõi -->
    <h4 class="mt-4 mb-3 fw-bold text-primary">üé¨ Su·∫•t chi·∫øu s·∫Øp t·ªõi</h4>
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Th·ªùi gian</th>
          <th>T√™n phim</th>
          <th>Th·ªÉ lo·∫°i</th>
          <th>Ph√≤ng chi·∫øu</th>
          <th></th>
        </tr>
      </thead>
      <tbody>
        {% for s in upcoming %}
          <tr>
            <td>{{ s.date_time|date:"d/m/Y H:i" }}</td>
            <td>
              <a href="{% url 'movie_detail' s.movie.id %}" class="text-decoration-none">
                {{ s.movie.title }}
              </a>
            </td>
            <td>{{ s.movie.genre }}</td>
            <td>{{ s.room.name }}</td>
            <td class="text-end">
              {% if request.user.is_authenticated %}
                <a href="#"
                   class="btn btn-dark btn-sm open-booking"
                   data-toggle="modal" data-target="#bookingModal"
                   data-movie-id="{{ s.movie.id }}"
                   data-movie-title="{{ s.movie.title }}"
                   data-room-id="{{ s.room.id }}"
                   data-room-name="{{ s.room.name }}"
                   data-datetime="{{ s.date_time|date:'Y-m-d H:i:s' }}">
                   ƒê·∫∑t v√©
                </a>
              {% else %}
                <a href="#" class="btn btn-secondary btn-sm" data-toggle="modal" data-target="#loginModal">
                  ƒêƒÉng nh·∫≠p ƒë·ªÉ ƒë·∫∑t v√©
                </a>
              {% endif %}
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="5" class="text-center text-muted">Ch∆∞a c√≥ su·∫•t s·∫Øp chi·∫øu</td></tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- üìΩ Su·∫•t ƒë√£ chi·∫øu -->
    <h4 class="mt-4 mb-3 fw-bold text-primary">üé¨ Su·∫•t ƒë√£ chi·∫øu</h4>
    <table class="table table-striped">
      <thead>
        <tr>
          <th>Th·ªùi gian</th>
          <th>T√™n phim</th>
          <th>Th·ªÉ lo·∫°i</th>
          <th>Ph√≤ng chi·∫øu</th>
        </tr>
      </thead>
      <tbody>
        {% for s in past %}
          <tr class="text-muted">
            <td>{{ s.date_time|date:"d/m/Y H:i" }}</td>
            <td>{{ s.movie.title }}</td>
            <td>{{ s.movie.genre }}</td>
            <td>{{ s.room.name }}</td>
          </tr>
        {% empty %}
          <tr><td colspan="4" class="text-center text-muted">Ch∆∞a c√≥ su·∫•t ƒë√£ chi·∫øu</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </section>
</div>

{# ==== Nh√∫ng modal ƒë·∫∑t v√© d√πng chung (ƒë√£ c√≥ s·∫µn ·ªü trang Phim) ==== #}
{% include "book_ticket/booking_modal.html" %}
{% endblock %}

{% block script %}
<script>
  // B·∫•m "ƒê·∫∑t v√©" ‚Üí m·ªü modal, prefill th√¥ng tin, t·∫£i gh·∫ø tr·ªëng
  $(document).on('click', '.open-booking', function (e) {
    e.preventDefault();

    const movieId   = $(this).data('movie-id');
    const movieName = $(this).data('movie-title');
    const roomId    = $(this).data('room-id');
    const roomName  = $(this).data('room-name');
    const dt        = $(this).data('datetime'); // "YYYY-MM-DD HH:MM:SS"

    const $modal = $('#bookingModal');

    // ƒêi·ªÅn gi√° tr·ªã ·∫©n ƒë·ªÉ POST v·ªÅ user_booking
    $modal.find('input[name="movie_id"]').val(movieId);
    $modal.find('input[name="room_id"]').val(roomId);
    $modal.find('input[name="date_time"]').val(dt);

    // C·∫≠p nh·∫≠t text hi·ªÉn th·ªã trong modal (n·∫øu b·∫°n c√≥ c√°c span n√†y)
    $modal.find('[data-bind="movie_title"]').text(movieName);
    $modal.find('[data-bind="room_name"]').text(roomName);
    $modal.find('[data-bind="showtime"]').text(dt);

    // T·∫£i gh·∫ø tr·ªëng cho ƒë√∫ng su·∫•t
    const $seatContainer = $modal.find('#seat-container');
    $seatContainer.html('<p class="text-muted mb-0">ƒêang t·∫£i gh·∫ø...</p>');

    $.getJSON(`/api/seats/?movie_id=${movieId}&room_id=${roomId}&date_time=${encodeURIComponent(dt)}`)
      .done(function (res) {
        const nums = res.available_seats || [];
        if (!nums.length) {
          $seatContainer.html('<p class="text-danger mb-0">H·∫øt gh·∫ø tr·ªëng cho su·∫•t n√†y.</p>');
          return;
        }
        let html = '<div class="d-flex flex-wrap">';
        nums.forEach(n => {
          html += `
            <label class="border rounded p-2 m-1">
              <input type="checkbox" name="selected_seats[]" value="${n}">
              Gh·∫ø ${n}
            </label>`;
        });
        html += '</div>';
        $seatContainer.html(html);
      })
      .fail(function () {
        $seatContainer.html('<p class="text-danger mb-0">Kh√¥ng t·∫£i ƒë∆∞·ª£c danh s√°ch gh·∫ø.</p>');
      });

    // M·ªü modal
    $modal.modal('show');
  });
</script>
{% endblock %}
